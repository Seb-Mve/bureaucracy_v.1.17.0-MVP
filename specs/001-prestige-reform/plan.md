# Implementation Plan: Système de Prestige "Réforme Administrative"

**Branch**: `001-prestige-reform` | **Date**: 2025-01-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-prestige-reform/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implémentation du système de prestige "Réforme Administrative" pour BUREAUCRACY++, permettant aux joueurs de réinitialiser leur progression en échange de Trombones (monnaie de prestige permanente). Les Trombones servent à acheter des améliorations de prestige qui offrent des bonus temporaires (actifs durant un run). Le système inclut :
- Calcul temps-réel du potentiel de prestige (formule trans-phasique : `floor(sqrt(V/Coefficient))`)
- Boutique de 5 améliorations de prestige (modificateurs de production, capacité de stockage)
- Persistance des Trombones et de la progression entre strates
- Mécanisme de sauvegarde robuste avec two-phase commit pour éviter la perte de données

**Technical Approach**: Extension du schéma AsyncStorage v4→v5, ajout de pure functions dans `/data`, nouveaux hooks dans GameStateContext, nouvelle entrée dans le menu burger pour la boutique de prestige.

## Technical Context

**Language/Version**: TypeScript 5.8.3 avec React 19.0.0 et React Native 0.79.1  
**Primary Dependencies**: Expo SDK 53.0.0 (Expo Router, AsyncStorage, Haptics), Lucide React Native (icônes)  
**Storage**: AsyncStorage (@react-native-async-storage/async-storage 1.21.0) - localStorage local, pas de backend  
**Testing**: Tests manuels sur simulateurs iOS/Android (pas de framework de tests automatisés actuellement)  
**Target Platform**: iOS 15+ et Android 8+ (via Expo managed workflow), Web supporté via `expo export --platform web`  
**Project Type**: Mobile (React Native Expo) avec architecture à 5 couches (components, context, data, types, constants)  
**Performance Goals**: 60fps sur iPhone 11/Android équivalent, <100ms réponse perçue pour interactions UI, <200ms pour calculs de prestige  
**Constraints**: AsyncStorage limité à 6MB (iOS) / 50MB (Android), offline-first (pas de connexion réseau requise), sauvegarde debounced à 5s  
**Scale/Scope**: Single-player local, ~15 entités prestige (5 upgrades, Trombone, VAT, Strate, etc.), ~500 lignes de code nouveaux

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: User Experience & Performance
- [x] Feature provides immediate visual feedback (<100ms perceived response) - Jauge temps réel, toast instantanés
- [x] Performance impact assessed for 60fps target on mid-range devices - Calculs légers (sqrt, additions), pas d'animations complexes
- [x] Idle game mechanics remain accurate across app lifecycle (background/resume) - Trombones persistés dans AsyncStorage
- [x] AsyncStorage operations are batched and non-blocking - Sauvegarde debounced à 5s (existant), two-phase commit évite les blocages

### Principle II: Code Quality & Maintainability
- [x] Game logic separated from presentation components - Logique pure dans `/data/prestigeLogic.ts`
- [x] State management uses React Context pattern (GameStateContext) - Extension de GameStateContext.tsx
- [x] Business logic implemented as pure, testable functions - `calculatePrestigePotential()`, `applyPrestigeMultipliers()`, etc.
- [x] Components follow single responsibility (<300 lines) - Boutique prestige séparée en composant dédié
- [x] TypeScript strict mode with justified `any` types only - Aucun `any` prévu
- [x] Complex logic has JSDoc comments - Formule trans-phasique documentée
- [x] Game constants defined in centralized data files - Catalogue d'upgrades dans `data/gameData.ts`

### Principle III: French Language & Cultural Authenticity
- [x] All in-game text in French with authentic bureaucratic terminology - "Réforme Administrative", "Trombones", "Potentiel de Réforme"
- [x] Proper French accents, grammar, and orthography - Vérifié dans spec (accents corrects)
- [x] References to real French administrative structures where appropriate - "Décret temporaire" pour upgrades
- [x] Number formatting follows French conventions (1 000, 1,5) - Fonction existante `formatNumberFrench()` réutilisée
- [x] Date/time uses French locale (dd/mm/yyyy) - N/A (pas de timestamps affichés)

### Principle IV: Accessibility & Inclusive Design
- [x] Touch targets minimum 44×44 points - Boutons boutique respectent la taille minimale
- [x] Color not sole means of conveying information (icons + text) - Statut "ACTIF" indiqué par icône + texte
- [x] Text contrast meets WCAG 2.1 AA (4.5:1 normal, 3:1 large) - Palette existante respecte WCAG
- [x] Accessibility labels for all icons/images - Labels pour lecteurs d'écran sur tous les boutons
- [x] Font sizes responsive to system settings - Police system React Native
- [x] Playable without sound/haptics (visual alternatives) - Feedback visuel toast + animations

### Principle V: Architectural Separation of Concerns
- [x] Presentation layer (`/components`) only renders UI - `PrestigeShopModal.tsx` = UI pure
- [x] State layer (`/context`) manages game state - GameStateContext expose `performPrestige()`, `buyPrestigeUpgrade()`
- [x] Business logic layer (`/data`) contains calculations - `/data/prestigeLogic.ts` avec formules pures
- [x] Type definitions in `/types` - Types ajoutés dans `types/game.ts`
- [x] Constants in `/constants` - **EXCEPTION DOCUMENTÉE**: `prestigeUpgrades` reste dans `/data/gameData.ts` suivant le pattern cohérent existant (`agents`, `administrations` déjà dans gameData.ts). Justification : gameData.ts sert de catalogue centralisé pour les entités de jeu statiques avec leurs métadonnées complètes (coûts, effets, descriptions). Ce pattern facilite la maintenance et évite la fragmentation des données de référence.
- [x] Unidirectional dependencies: Presentation → State → Logic - Respecté
- [x] Components don't directly import from `/data` - Hooks du Context uniquement
- [x] Pure functions in `/data` have no React dependencies - Aucune import React dans `prestigeLogic.ts`

## Project Structure

### Documentation (this feature)

```text
specs/001-prestige-reform/
├── plan.md              # This file (complete implementation plan)
├── spec.md              # Feature specification (input - already exists)
├── research.md          # Phase 0 output (generated below)
├── data-model.md        # Phase 1 output (generated below)
├── quickstart.md        # Phase 1 output (generated below)
├── contracts/           # Phase 1 output (generated below)
│   └── prestige-api.ts  # Type contracts for prestige operations
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
# React Native Expo app (single mobile project)

types/
└── game.ts              # [EDIT] Add: PrestigeUpgrade, PrestigeState, Tier types

data/
├── gameData.ts          # [EDIT] Add: prestigeUpgrades array (5 upgrades)
├── prestigeLogic.ts     # [NEW] Pure functions: calculatePrestigePotential, applyPrestigeMultipliers, etc.
├── storageLogic.ts      # [NO CHANGE] (reference for two-phase commit pattern)
└── conformiteLogic.ts   # [NO CHANGE] (reference for pure function pattern)

context/
└── GameStateContext.tsx # [EDIT] Add: performPrestige(), buyPrestigeUpgrade(), getPrestigePotential()

components/
├── PrestigeShopModal.tsx           # [NEW] Boutique prestige (modal full-screen)
├── PrestigeGauge.tsx               # [NEW] Jauge "Potentiel de Réforme" (affichage temps réel)
├── PrestigeUpgradeCard.tsx         # [NEW] Carte individuelle d'amélioration
├── MenuBottomSheet.tsx             # [EDIT] Add: "Boutique de Prestige" menu item
└── ToastContainer.tsx              # [NO CHANGE] (réutilisé pour feedback achat)

app/(tabs)/
├── options.tsx          # [EDIT] Rename "Réinitialiser le jeu" → "Réforme Administrative", add PrestigeGauge
└── _layout.tsx          # [EDIT] Add menu item "Boutique de Prestige" (no badge)

utils/
├── stateMigration.ts    # [EDIT] Add v4→v5 migration logic
└── formatters.ts        # [NO CHANGE] (formatNumberFrench already exists)

.specify/
└── memory/
    └── copilot-instructions.md # [EDIT] Update agent context with prestige system knowledge
```

**Structure Decision**: Single React Native Expo project with clear layer separation. All prestige logic follows existing patterns (conformiteLogic.ts, storageLogic.ts). New UI components integrated via menu burger (pas d'onglet principal). Migration AsyncStorage suit le pattern existant v3→v4 pour étendre à v5.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

Aucune violation détectée. Tous les principes constitutionnels sont respectés sans nécessiter de justification de complexité.
